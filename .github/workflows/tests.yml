name: Run Unit Tests

on:
  workflow_call:

jobs:
  tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    permissions:
      id-token: write
      pull-requests: write
      contents: write
    steps:
    - uses: actions/checkout@v4
    - name: Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install uv
      uses: astral-sh/setup-uv@v6
    - name: Install tests requirements
      run: uv sync --locked --group tests
    - name: Run tests coverage
      run: |
        uv run pytest \
          --cov \
          --cov-config=pyproject.toml \
          --cov-report=term-missing \
          --cov-report=xml:coverage.xml \
          --junitxml=pytest.xml
    # - name: Coverage comment
    #   if: always()
    #   id: coverage
    #   uses: MishaKav/pytest-coverage-comment@main
    #   with:
    #     # Core
    #     github-token: ${{ secrets.GITHUB_TOKEN }}
    #     pytest-coverage-path: ./pytest-coverage.txt
    #     pytest-xml-coverage-path: ./coverage.xml
    #     junitxml-path: ./pytest.xml

    #     # Display
    #     junitxml-title: Tests Summary
    #     report-only-changed-files: true
    #     xml-skip-covered: true

    #     # Advanced
    #     unique-id-for-comment: tests-${{ matrix.python-version }}
    - name: Upload coverage reports to Codecov
      if: always() && matrix.python-version == '3.11'
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: coverage.xml
    - name: Upload test results to Codecov
      if: always() && matrix.python-version == '3.11'
      uses: codecov/test-results-action@v1
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: pytest.xml
